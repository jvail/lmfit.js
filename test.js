var lmfit = require('./lmfit.js')
  , fs = require('fs')
  , verbose = false
  ;

/*
  data = {
      verbose: true|false
    , f: function (){}  model function
      n: 0              no. of params
    , par:[]            initial param guess
    , m: 0              no. of data points
    , t: []             array x-axis points
    , y: []             array y-axis points
  }
*/

/* logistic function */
(function () {

  var vals = [109.25, 109.13, 112.67, 117.50, 122.78, 122.67, 122.56, 128.82, 134.56, 139.92, 143.97, 148.23, 151.35, 158.73, 158.60, 162.71, 169.55, 173.16, 176.13, 175.94, 175.78, 178.52, 183.95, 187.92, 193.51, 199.56, 207.02, 206.74, 206.56, 211.66, 215.88, 217.72, 224.01, 226.18, 225.85, 228.63, 233.95, 242.19, 251.13, 259.87, 259.34, 259.03, 258.79, 258.54, 258.27, 258.00, 257.75, 263.84, 263.48, 267.34, 275.99, 275.54, 275.31, 275.10, 274.85, 274.59, 274.36, 274.17, 274.00, 273.86, 273.74, 273.61, 273.40, 273.24, 273.06, 272.84, 272.61, 272.33, 277.94, 279.69, 281.59, 283.74, 286.13, 288.96, 291.10, 290.62, 290.22, 289.97, 289.73, 292.85, 295.90, 299.10, 298.54, 298.22, 301.83, 301.44, 301.27, 301.12, 300.98, 300.82, 300.67, 300.48, 300.23, 299.99, 299.74, 299.49, 299.27, 299.04, 298.81, 298.53, 298.26, 297.98, 297.69, 307.03, 313.90, 313.26, 322.84, 322.20, 330.83, 339.26, 338.57, 347.60, 346.97, 346.48, 346.03, 345.50, 344.98, 344.45, 356.25, 370.69, 390.58, 403.62, 402.81, 424.34, 423.58, 443.80, 480.80, 513.14, 535.10, 579.02, 628.29, 656.08, 683.65, 738.12, 792.43, 851.98, 900.99, 939.26, 937.28, 935.56, 934.00, 932.12, 930.34, 1002.67, 1070.07, 1121.41, 1180.74, 1250.64, 1306.87, 1304.18, 1301.67, 1374.58, 1371.66, 1368.93, 1366.27, 1363.74, 1487.04, 1599.14, 1749.86, 1880.15, 2008.45, 2128.30, 2239.11, 2384.47, 2547.31, 2736.04, 2945.15, 3149.37, 3365.67, 3463.03, 3588.38, 3721.68, 3834.23, 3825.55, 3976.97, 4166.68, 4362.63, 4588.89, 4791.41, 4925.78, 5085.76, 5310.68, 5469.44, 5652.27, 5822.81, 5949.53, 6137.81, 6326.74, 6433.06, 6604.77, 6853.34, 7105.82, 7326.61, 7397.44, 7457.64, 7590.31, 7718.90, 7796.00, 7958.50, 8123.38, 8335.15, 8569.42, 8743.80, 8942.68, 9180.54, 9413.48, 9628.89, 9820.79, 9988.28, 10169.81, 10388.90, 10609.84, 10806.50, 10964.82, 11172.70, 11325.08, 11497.99, 11678.89, 11813.58, 11947.77, 11998.49, 12141.44, 12291.78, 12386.34, 12538.91, 12668.18, 12767.90, 12851.56, 12906.21, 12963.69, 13105.36, 13272.26, 13322.15, 13357.12, 13540.35, 13697.76, 13845.35, 13926.63, 14066.55, 14246.83, 14410.04, 14582.58, 14572.12, 14552.68, 14489.33, 14394.57, 14277.25, 14159.27, 14255.43, 14364.97, 14525.98, 14568.02, 14569.07, 14592.05, 14756.08, 14784.48, 14760.59, 14738.14, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03, 14717.03];

  var data = {
      verbose: verbose
    , f: function(t, p) {
          return p[0] / (1 + p[1] * Math.exp(-p[2] * t));
      }
    , n: 3
    , par: new Float64Array(3)
    , m: 286
    , t: new Float64Array(vals.length)
    , y: new Float64Array(vals.length)
  }

  data.par[0] = 5.0;
  data.par[1] = 1.0;
  data.par[2] = 0.09;


  for (var t = 0; t < data.m; t++) {
    data.t[t] = t;
    data.y[t] = vals[t];
  }

  var ret = lmfit.fit(data);
  console.log(ret);

  fs.writeFileSync('test/logistic.csv', 't;data;fit\n');
  var csv = '';
  for (var t = 0; t < data.m; t++)
    csv += data.t[t] + ';' + vals[t] + ';' + data.f(data.t[t], ret.params) + '\n';
  fs.appendFileSync('test/logistic.csv', csv);

}());

/* wood curve (lactation) */
(function () {

  var data = {
      verbose: verbose
    , f: function(t, p) {
          return p[0] * Math.pow(t, p[1]) * Math.exp(p[2] * t);
      }
    , n: 3
    , par: new Float64Array(3)
    , m: 0
    , t: new Float64Array([ 1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0,11.0,12.0,13.0,14.0,15.0,16.0,17.0,18.0,19.0,20.0,21.0,22.0,23.0,24.0,25.0,26.0,27.0,28.0,29.0,30.0,31.0,32.0,33.0,34.0,35.0,36.0,37.0,38.0,39.0,40.0,41.0,42.0 ])
    , y: new Float64Array([ 17.3,27.65,28.14,27.69,30.35,29,28.07,28.16,27.2,26.21,26.03,25.6,25.49,24.31,24.31,24.54,24.29,24.42,24.24,24.84,23.43,22.86,22.1,22.4,21.49,20.43,19.7,18.03,18.49,18.2,15.84,13.49,12.67,12.68,13.45,12.89,13.4,14.37,13.7,12.19,11.13,10.47 ])
  }

  data.par[0] = 25.0;
  data.par[1] = 0.1504;
  data.par[2] = -0.0296;

  data.m = data.t.length;

  var ret = lmfit.fit(data);
  console.log(ret);

  fs.writeFileSync('test/wood.csv', 't;data;fit\n');
  var csv = '';
  var ts = Array.prototype.slice.call(data.t);
  for (var t = 1; t < 43; t++)
    csv += t + ';' + (ts.indexOf(t) >= 0 ? data.y[ts.indexOf(t)] : '') + ';' + data.f(t, ret.params) + '\n';
  fs.appendFileSync('test/wood.csv', csv);

}());

/* sqrt */
(function () {

  var data = {
      verbose: verbose
    , f: function(t, p) {
          return p[0] * Math.sqrt(t);
      }
    , n: 1
    , par: new Float64Array(1)
    , m: 0
    , t: new Float64Array([0.3163318692, 0.3727579753, 0.3735062368, 0.6638503943, 0.6780274146, 0.7770890439, 0.7938996289, 0.8035191014, 0.8165426204, 0.8230620262, 0.8391923081, 0.8463145049, 0.856223614, 0.8663082884, 0.8893367364, 0.9135820709, 0.921690481, 0.9222292567, 0.9343296682, 0.9444126537, 0.9781246002, 0.9977713596, 1.000733463, 1.0369530767, 1.0439779188, 1.1056663394, 1.147041747, 1.2990980118])
    , y: new Float64Array([0.4651027472, 0.5043415405, 0.5053539384, 0.7031089868, 0.7341988726, 0.7443432573, 0.8193328924, 0.7867720953, 0.761801725, 0.8360749353, 0.7910724981, 0.7878451406, 0.8532251371, 0.8071231042, 0.8743663356, 0.8605824839, 0.9867149995, 0.9040766883, 0.8973154076, 0.9307964316, 1.0411039528, 1.0417402387, 0.9562278852, 0.9971387509, 1.0821227456, 1.0189668197, 1.0888947665, 1.078217463])
  }

  data.par[0] = 1.0;

  data.m = data.t.length;

  var ret = lmfit.fit(data);
  console.log(ret);

}());
